<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense</title>
</head>
<body>
    <form onsubmit="saveExpense(event)">
        <label >Amount</label>
        <input id="amount" name="amount" type="number" required/>
        <label >description</label>
        <input id="description" name="description" type="text" required/>
        <label >category</label>
        <input id="category" name="category" type="text" required/>
        <button id="addExpense">Add Expense</button></form><br>
    </form>
    <button id="premium">Buy Premium</button>
    <script scr="https://checkout.razorpay.com/v1/checkout.js"></script>
    <ul id='listOfExpenses'></ul>
</body>
</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.2.0/axios.min.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <div id="addExpenses"></div>
    
<script>

    function saveExpense(event){
        event.preventDefault()
        const amount=event.target.amount.value
        const description=event.target.description.value
        const category=event.target.category.value
        const obj={
            amount,
            description,
            category
        }
       
        const token=localStorage.getItem('token')
        axios.post("http://localhost:4000/expense/addExpense",obj,{headers:{'Authorization':token}})
        .then(response=>{
            console.log(response)
            showUserOnScreen(response);
        })
        .catch(err=>console.log(err))
    }
    window.addEventListener('DOMContentLoaded',()=>{
        const token=localStorage.getItem('token')
        axios.get("http://localhost:4000/expense/getExpense",{headers:{'Authorization':token}})
        .then(response=>{
            console.log(response)
            for(var i=0;i<response.Expenses.length;i++){
                showUserOnScreen(response.Expenses[i])
            }
        })
        .catch(err=>console.log(err))
    })
    document.getElementById('premium').onclick=async function(e){
        
        const token=localStorage.getItem('token')
        const response=await axios.get("http://localhost:4000/purchase/membership",{headers:{'Authorization':token}})
        
        console.log(response)
        var options={
            'key_id':response.key_id,
            'order_id':response.order.id,
            'handler':async function(response){
                axios.post("http://localhost:4000/purchase/updateTransactionStatus",{
                    order_id:options.order_id,
                    payment_id:response.razorpay_payment_id
                },{headers:{'Authorization':token}})
                alert('You are a premium user now')
            }
        };
        const rzp1=new Razorpay(options);
        rzp1.open();
        e.preventDefault();
        rzp1.on('payment.failed',function(response){
            console.lo(response)
            alert('something went wrong')
        });

    
    
}
function showUserOnScreen(user){
        const parentNode=document.getElementById('listOfExpenses')
        const childHTML=`<li id=${user.id}> ${user.amount}-${user.description}-${user.category}
            <button onclick="deleteUser(${user.id})">DeleteUser</button>
            <button onclick="editUser(${user.id},${user.email},${user.description},${user.category}")>editUser</button>
            </li>`
            parentNode.innerHTML=parentNode.innerHTML+childHTML
            document.getElementById('amount').value=''
            document.getElementById('description').value=''
            document.getElementById('category').value=''
    }
function editUser(id,amount,description,category){
    document.getElementById('amount').value=amount
    document.getElementById('description').value=description
    document.getElementById('category').value=category
    deleteUser(id)
}
async function deleteUser(id){
    const childNodeToBeDeleted=document.getElementById(id)
    if(childNodeToBeDeleted){
        const token=localStorage.getItem('token')
        await axios.delete(`http://localhost:4000/expense/${id}`,{headers:{'Authorization':token}})
        .then((response)=>{
            if(response.status===400){
                throw new Error(response.message)
            }
            else if(response.status===200){
                console.log(response.message)
            }

        })
        .catch(err=>console.log(err))
    }
}
function removeFromScreen(id){
    let parent=document.getElementById('listOfExpenses')
    let childToBeRemoved=document.getElementById(id)
    parent.removeChild(childToBeRemoved)
}
</script>